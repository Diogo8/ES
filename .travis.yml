dist: trusty
language: ruby
rvm:
  - 2.5.1

addons:
  postgresql: 9.6

notifications:
  slack: pl5es:84Pa1a9D0o7hXNvlby4JeYl2

jobs:
  include:
    - stage: Build
      before_script:
        - cd code/server
        - bundle install
        - cp config/database.yml.travis config/database.yml
        - psql -c 'create database travis_ci_test;' -U postgres
      script:
        - bundle exec rubocop
        - bundle exec rails db:migrate RAILS_ENV=test
        - bundle exec rspec

    - stage: Deploy Server
      before_script:
        - cd code/server
      deploy:
        provider: heroku
        api_key: $HEROKU_API_KEY
        app:
          master: pando-api-staging
        run: "rails db:migrate"

    - stage: Deploy Web
      before_script:
        - cd code/web
      deploy:
        provider: heroku
        api_key: $HEROKU_API_KEY
        app:
          master: pando-web-staging
